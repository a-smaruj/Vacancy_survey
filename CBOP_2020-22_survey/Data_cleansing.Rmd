---
title: "R Notebook"
output: html_notebook
---

```{r}
library(RcppSimdJson)
library(data.table)
library("lubridate")
library(tidyverse)
library(janitor)
```

```{r}
read_cbop <- function(file) {
  cbop_file <- readLines(file)
  cbop <- fparse(json = cbop_file[1])

  cbop_list <- list()
  for (i in 1:length(cbop)) {
    
      prac <- cbop[[i]]$danePracodawcy
      names(prac) <- cbop[[i]]$hash
      prac_df <-  rbindlist(prac, idcol = "hash")
      setnames(prac_df, names(prac_df)[-1], paste0("prac_", names(prac_df)[-1]))
      
      pozostaleDane <- rbindlist(cbop[[i]]$pozostaleDane)
      setnames(pozostaleDane, names(pozostaleDane), paste0("poz_", names(pozostaleDane)))
      
      warunkiPracyIPlacy <- rbindlist(cbop[[i]]$warunkiPracyIPlacy)
      setnames(warunkiPracyIPlacy, names(warunkiPracyIPlacy), 
               paste0("war_", names(warunkiPracyIPlacy)))
      
      prac_df <- cbind(prac_df, pozostaleDane, warunkiPracyIPlacy)
      
      prac_df[, ":="(typOferty = cbop[[i]]$typOferty,
                     czyWazna = cbop[[i]]$czyWazna,
                     statusOferty = cbop[[i]]$statusOferty)]
      cbop_list[[i]] <- prac_df
  }

  cbop_list_df <- rbindlist(cbop_list)
  cbop_list_df[, .SD, .SDcols = names(cbop_list_df) %like% "data|oferta"]
  cbop_list_df[, ":="(poz_dataPrzyjZglosz=dmy(poz_dataPrzyjZglosz),
                      poz_ofertaWaznaDo=dmy(poz_ofertaWaznaDo))]
  
  final_df <- cbop_list_df[  typOferty == "OFERTA_PRACY" & 
                             czyWazna == TRUE & 
                             war_kraj == "Polska" & 
                        (!is.na(prac_regon) | !is.na(prac_nip)) &
                          war_rodzajZatrudnienia %in% 
                              c("Umowa o pracę na czas określony",                                                        "Umowa o pracę na czas nieokreślony", 
                                "Umowa o pracę w zastępstwie", 
                                "Umowa o pracę na okres próbny",
                                "Umowa na czas wyk. określonej pracy")][
                          , ":="(prac_nip = str_remove_all(prac_nip, "-"),
                                 kod_pocztowy = str_extract(war_miejscePracy,
                                                            "\\d{2}\\-\\d{3}"))][
                            !prac_nip %in% c("0000000000", "1111111111")]

  final_df[, ":="(war_gmina = tolower(war_gmina), 
                  war_ulica=tolower(war_ulica),
                  war_miejscowosc=tolower(war_miejscowosc),
                  war_stanowisko=tolower(war_stanowisko))]
  final_df[, war_ulica:=str_replace(war_ulica,  "pl\\.", "plac ")]	
  final_df[, war_ulica:=str_replace(war_ulica,  "al\\.", "aleja ")]	
  final_df[, war_ulica:=str_replace(war_ulica,  "  ", " ")]	
  final_df[, war_ulica:=str_remove(war_ulica,  "^\\.|-$")]
  final_df[, ":="(war_gmina = str_remove(war_gmina, "m.st. "))]
  final_df[, kod_pocztowy:=str_remove(kod_pocztowy, "00-000")]
  final_df[kod_pocztowy == "", kod_pocztowy := NA]
  final_df[, poz_kodZawodu := str_remove(poz_kodZawodu, "RPd057\\|")]
  final_df[, poz_grupaZawodu := substr(poz_kodZawodu, 1, 1)]
  final_df[, prac_regon := substr(prac_regon, 1, 9)]
  final_df[, poz_dataUdostepnieniaOferty := ymd(poz_dataUdostepnieniaOferty)]

  return(final_df)
}
```

```{r}
create_table <- function(cbop_year, files) {

  for (file in files) {
    cbop_year[[length(cbop_year)+1]] <- read_cbop(file)
  }
  
  files <- str_remove_all(files, '(data\\\\\\d+\\\\|_full.json)')
  
  names(cbop_year) <- basename(files)
  cbop_year <- rbindlist(cbop_year, idcol = "file")
  
  cbop_year <- cbop_year %>% remove_constant()
  cbop_year$file <- ymd(cbop_year$file)
  
  return(cbop_year)
}
```

```{r}
remove_duplicates <- function(cbop_year) {
  
  #Identical job offers
  cbop_year <- cbop_year %>% filter(duplicated(cbop_year,
                                               by=names(cbop_year)[names(cbop_year)
                                                                   !='file'], 
                                       fromLast = TRUE) == FALSE)
  
  #Prolonged job offers
  cbop_year <- cbop_year %>% filter(duplicated(cbop_year, 
                                       by=names(cbop_year)[!names(cbop_year) %in% 
                                                    c('file','poz_ofertaWaznaDo')], 
                                       fromLast = TRUE) == FALSE)
  
  #TODO
  
  return(cbop_year)
}
```

```{r}
#Number of unique hash/job offers
n <- length(unique(cbop_2020$hash))

#remove polish letters - takes a lot of time
cbop_2020$war_stanowisko %>% make_clean_names()
cbop_2020$war_stanowisko

#Table with duplicates and with unique value
e_duplicate <- cbop_2020 %>% get_dupes(hash)

e_unique <- setdiff(cbop_2020, e_duplicate[,-2,with=FALSE])

#Remove duplicates cd.

#not working, problem with name "column"
for (column in columns_to_clean) {
  e_duplicate$column <- str_remove(e_duplicate$column %>% make_clean_names(), '\\_\\d$')
}

e_duplicate <- e_duplicate[,-2,with=FALSE] %>% filter(duplicated(e_duplicate, 
                                       by=names(e_duplicate)[!names(e_duplicate) %in% 
                                                    c('file','poz_ofertaWaznaDo')], 
                                       fromLast = TRUE) == FALSE)

e_duplicate_2 <- e_duplicate %>% get_dupes(hash)
e_unique <- rbind(setdiff(e_duplicate, e_duplicate_2[,-2,with=FALSE]), e_unique)

#Analysis - duplicates
e_duplicate <- e_duplicate %>% arrange(desc(hash))
e_duplicate %>% filter(hash == 'fcdb1d45049fbe8bdff2fb6b397fba5c')
```

```{r}
#Notatki
#Różnice w prac_pracodawca (Sp ZOO, Sk....)
#Różnice w war_wynagrodzenieBrutto
#Osoba do kontatku + numer kontaktowy
#war_dataRozpoczęciaPracy np. (file 08.11.2020) 09.11.2020, (26.11.2020) 16.11.2020, (29.11.2020) 01.12.2020 lub (file 07.12.2020) 04.12.2020, (08.12.2020) 12.12.2020
#polskie litery - war_stanowisko zakłądu
#war_stanowisko: "specjalista ds. handlowych-133"	i "133-specjalista ds. handlowych"

```

```{r}
#2020
cbop_2020 <- list()
files <- Sys.glob('data\\2020\\*.json')
cbop_2020<- create_table(cbop_2020, files)
cbop_2020 <- remove_duplicates(cbop_2020)
```

```{r}
#2022
cbop_2022 <- list()
files <- Sys.glob('data\\2022\\*.json')
cbop_2022 <- create_table(cbop_2022, files)
cbop_2022 <- remove_duplicates(cbop_2022)
```

```{r}
#2021
files <- Sys.glob('data\\2021\\*.json') 

cbop_2021_1 <- list()
files_1 <- files[1:floor(length(files)/2)]
cbop_2021_1 <- create_table(cbop_2021_1, files_1)
cbop_2021_1 <- remove_duplicates(cbop_2021_1)

cbop_2021_2 <- list()
files_2 <- files[(1+floor(length(files)/2)):length(files)]
cbop_2021_2 <- create_table(cbop_2021_2, files_2)
cbop_2021_2 <- remove_duplicates(cbop_2021_2)

cbop_2021 <- rbindlist(list(cbop_2021_1, cbop_2021_2))
rm(cbop_2021_1)
rm(cbop_2021_2)

cbop_2021 <- remove_duplicates(cbop_2021)
```

```{r}
#Useful columns
columns <- c('file', 'hash', 'poz_identyfikatorOferty', 'poz_kodZawodu', 
             'poz_grupaZawodu', 'poz_lWolnychMiejsc', 'poz_dataUdostepnieniaOferty',
             'poz_dataPrzyjZglosz', 'poz_ofertaWaznaDo', 'poz_ofertaZgloszonaPrzez', 
             'poz_ofertaZgloszonaPrzezKodJednostki', 'war_kraj', 'war_wojewodztwo',
             'war_kodWojewodztwa', 'war_powiat', 'war_kodPowiatu', 'war_gmina',
             'war_miejscowosc', 'war_kodMiejscowosci', 'war_ulica', 'war_miejscePracy',
             'war_zawod', 'war_stanowisko', 'war_wymiarEtatu', 'war_rodzajZatrudnienia',
             'war_kodRodzajuZatrudnienia', 'war_pensjaNetto', 'prac_nazwaUrzeduPracy',
             'statusOferty', 'kod_pocztowy')

columns_to_clean <- c("prac_pracodawca", "prac_adres", "prac_emailOsobyZglPracodawca", 
                       "prac_profilDzialanosci", "prac_miejscowoscPracodawca", 
                       "prac_powiatPracodawca", "prac_wojewodztwoPracodawca", 
                       "prac_wymaganeDokumenty", "prac_email", 
                       "prac_imieNazwiskoOsobyZglPracodawca", "prac_jezykAplikacji",
                       "prac_branza", "prac_nazwaUrzeduPracy", "prac_ulica", 
                       "prac_typPodmiotu", "poz_potwierdzenieWiedzy", "poz_celeEdukacyjne",
                       "poz_nazwaLiczMiejsc", "war_miejscePracyCzlonDrugi",
                       "war_powodOddelegowania", "war_rodzajZatrudnienia", "war_wojewodztwo",
                       "war_ulica", "war_zawod", "war_opisWynagrodzenia",
                       "war_systemWynagradzania", "war_stanowisko", "war_miejscowosc",
                       "typOfertyNaglowek", "kodJezyka", "prac_osobaDoKontaktu",
                       "prac_publikowacDanePracodawcy", "prac_kraj", "prac_sposobAplShort",
                       "prac_sposobAplikowania", "prac_wojewodztwo", "prac_adresWww",
                       "prac_ulicaPracodawca", "prac_powiat", "prac_gmina", 
                       "prac_krajPracodawca", "prac_adresAplPracodawca", "prac_miejscowosc",
                       "prac_sposobPrzekazaniaDok", "prac_gminaPracodawca", "poz_zawod",
                       "poz_wykorzystanieOferty", "poz_ofertaZgloszonaPrzez",
                       "war_rodzajWynagrodzenia", "war_lokalizacja", "war_zakresObowiazkow",
                       "war_rodzajObowiazkow", "war_opisOferty", 
                       "war_miejscePracyCzlonPierwszy", "war_powiat", 
                       "war_informacjeOLokalizacji", "war_gmina", "war_miejscePracy",
                       "war_dodSwiadczenia", "war_wymiarEtatu",  
                       "war_skroconyRodzajZatrudnienia", "war_zmianowosc", "nazwa")

cbop_2020 <- cbop_2020[, ..columns]
```

```{r}
#2020-2022 All
cbop_all <- rbindlist(list(cbop_2020, cbop_2021, cbop_2022))
cbop_all <- remove_duplicates(cbop_all)
```

```{r}
#Create RDS files
saveRDS(cbop_2020, file = "cbop_2020.rds")
saveRDS(cbop_2021, file = "cbop_2021.rds")
saveRDS(cbop_2022, file = "cbop_2022.rds")
saveRDS(cbop_all, file = "cbop_all.rds")
```